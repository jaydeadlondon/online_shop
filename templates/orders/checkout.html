{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - WorldPactLeader{% endblock %}

{% block extra_css %}
<style>
    .StripeElement {
        box-sizing: border-box;
        height: 40px;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background-color: white;
        box-shadow: 0 1px 3px 0 #e6ebf1;
        transition: box-shadow 150ms ease;
    }
    
    .StripeElement--focus {
        box-shadow: 0 1px 3px 0 #cfd7df;
        border-color: #000;
    }
    
    .StripeElement--invalid {
        border-color: #fa755a;
    }
    
    .StripeElement--webkit-autofill {
        background-color: #fefde5 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen pt-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h1 class="text-3xl font-bold mb-8">Checkout</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Checkout Form -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">Shipping Information</h2>
                    <form id="checkout-form" method="post">
                        {% csrf_token %}
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="first_name" class="block text-sm font-medium mb-2">First Name</label>
                                <input type="text" id="first_name" name="first_name" required
                                       class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-black">
                            </div>
                            <div>
                                <label for="last_name" class="block text-sm font-medium mb-2">Last Name</label>
                                <input type="text" id="last_name" name="last_name" required
                                       class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-black">
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="email" class="block text-sm font-medium mb-2">Email</label>
                            <input type="email" id="email" name="email" value="{{ user.email }}" required
                                   class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-black">
                        </div>
                        
                        <div class="mb-4">
                            <label for="address" class="block text-sm font-medium mb-2">Address</label>
                            <input type="text" id="address" name="address" required
                                   class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-black">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="city" class="block text-sm font-medium mb-2">City</label>
                                <input type="text" id="city" name="city" required
                                       class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-black">
                            </div>
                            <div>
                                <label for="state" class="block text-sm font-medium mb-2">State/Province</label>
                                <input type="text" id="state" name="state" required
                                       class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-black">
                            </div>
                            <div>
                                <label for="zip_code" class="block text-sm font-medium mb-2">ZIP Code</label>
                                <input type="text" id="zip_code" name="zip_code" required
                                       class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-black">
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label for="country" class="block text-sm font-medium mb-2">Country</label>
                            <input type="text" id="country" name="country" required
                                   class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-black">
                        </div>
                        
                        <h2 class="text-xl font-bold mb-4">Payment Information</h2>
                        
                        <div class="mb-4">
                            <label for="card-element" class="block text-sm font-medium mb-2">Credit or debit card</label>
                            <div id="card-element" class="StripeElement"></div>
                            <div id="card-errors" class="text-red-500 text-sm mt-2" role="alert"></div>
                        </div>
                        
                        <button type="submit" id="submit-button"
                                class="w-full px-8 py-3 bg-black text-white font-medium rounded hover:bg-gray-800 transition-colors">
                            <span id="button-text">Pay ${{ total|floatformat:2 }}</span>
                            <span id="spinner" class="hidden">Processing...</span>
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg p-6 sticky top-24">
                    <h2 class="text-xl font-bold mb-4">Order Summary</h2>
                    
                    <div class="space-y-4 mb-6">
                        {% for item in cart_items %}
                        <div class="flex gap-3">
                            <div class="w-16 h-16 bg-gray-100 rounded overflow-hidden flex-shrink-0">
                                {% if item.product.images.all.0 %}
                                <img src="{{ item.product.images.all.0.image.url }}" 
                                     alt="{{ item.product.name }}"
                                     class="w-full h-full object-cover">
                                {% endif %}
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium">{{ item.product.name }}</p>
                                <p class="text-xs text-gray-500">Qty: {{ item.quantity }}</p>
                                <p class="text-sm font-bold">${{ item.subtotal|floatformat:2 }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="space-y-2 mb-4 text-sm">
                        <div class="flex justify-between">
                            <span>Subtotal</span>
                            <span>${{ subtotal|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Shipping</span>
                            <span>{% if shipping_cost == 0 %}Free{% else %}${{ shipping_cost|floatformat:2 }}{% endif %}</span>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <div class="flex justify-between font-bold text-lg">
                            <span>Total</span>
                            <span>${{ total|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements();
    const cardElement = elements.create('card');
    cardElement.mount('#card-element');
    
    cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });
    
    const form = document.getElementById('checkout-form');
    const submitButton = document.getElementById('submit-button');
    const buttonText = document.getElementById('button-text');
    const spinner = document.getElementById('spinner');
    
    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        submitButton.disabled = true;
        buttonText.classList.add('hidden');
        spinner.classList.remove('hidden');
        
        const {paymentMethod, error} = await stripe.createPaymentMethod({
            type: 'card',
            card: cardElement,
            billing_details: {
                name: document.getElementById('first_name').value + ' ' + document.getElementById('last_name').value,
                email: document.getElementById('email').value,
                address: {
                    line1: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    postal_code: document.getElementById('zip_code').value,
                    country: document.getElementById('country').value,
                }
            }
        });
        
        if (error) {
            const errorElement = document.getElementById('card-errors');
            errorElement.textContent = error.message;
            submitButton.disabled = false;
            buttonText.classList.remove('hidden');
            spinner.classList.add('hidden');
        } else {
            // Отправляем payment method ID на сервер
            const formData = new FormData(form);
            formData.append('payment_method_id', paymentMethod.id);
            
            try {
                const response = await fetch('{% url "checkout" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                
                const data = await response.json();
                
                if (data.error) {
                    const errorElement = document.getElementById('card-errors');
                    errorElement.textContent = data.error;
                    submitButton.disabled = false;
                    buttonText.classList.remove('hidden');
                    spinner.classList.add('hidden');
                } else if (data.requires_action) {
                    // Требуется 3D Secure
                    const {error: confirmError} = await stripe.confirmCardPayment(data.payment_intent_client_secret);
                    
                    if (confirmError) {
                        const errorElement = document.getElementById('card-errors');
                        errorElement.textContent = confirmError.message;
                        submitButton.disabled = false;
                        buttonText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                    } else {
                        window.location.href = data.redirect_url;
                    }
                } else {
                    window.location.href = data.redirect_url;
                }
            } catch (error) {
                const errorElement = document.getElementById('card-errors');
                errorElement.textContent = 'An error occurred. Please try again.';
                submitButton.disabled = false;
                buttonText.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }
    });
</script>
{% endblock %}

